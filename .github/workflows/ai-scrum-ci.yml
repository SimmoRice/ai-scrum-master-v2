name: AI Scrum Master CI

on:
  pull_request:
    branches: [staging, main]

jobs:
  test:
    runs-on: ubuntu-latest
    name: Automated Tests & Security Checks

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
        if: hashFiles('**/package.json') != ''

      - name: Install dependencies
        run: |
          if [ -f package.json ]; then
            npm ci
          else
            echo "No package.json found, skipping npm install"
          fi

      - name: Run unit tests
        run: |
          if [ -f package.json ]; then
            if npm run test --dry-run 2>/dev/null; then
              npm test
            else
              echo "No test script configured, skipping"
            fi
          else
            echo "No package.json found, skipping tests"
          fi

      - name: Run linting
        run: |
          if [ -f package.json ]; then
            if npm run lint --dry-run 2>/dev/null; then
              npm run lint
            else
              echo "No lint script configured, skipping"
            fi
          else
            echo "No package.json found, skipping linting"
          fi

      - name: Security audit
        run: |
          if [ -f package.json ]; then
            npm audit --audit-level=high || echo "⚠️ Security vulnerabilities found - review required"
          else
            echo "No package.json found, skipping security audit"
          fi

      - name: Build verification
        run: |
          if [ -f package.json ]; then
            if npm run build --dry-run 2>/dev/null; then
              npm run build
            else
              echo "No build script configured, skipping"
            fi
          else
            echo "No package.json found, skipping build"
          fi

      - name: Check for test artifacts
        run: |
          echo "Checking for test artifacts..."
          ARTIFACTS=$(find . -type f \( -name "test.html" -o -name "temp.*" -o -name "debug.*" -o -name "hello.txt" \) ! -path "*/node_modules/*" ! -path "*/.git/*")

          if [ -n "$ARTIFACTS" ]; then
            echo "❌ Test artifacts found! Please clean up:"
            echo "$ARTIFACTS"
            exit 1
          else
            echo "✅ No test artifacts found"
          fi

      - name: Comment test results
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? '✅' : '❌';
            const body = `${status} **Automated CI checks completed**

            **Status:** ${{ job.status }}
            **Commit:** ${{ github.sha }}

            ${status === '❌' ? '⚠️ Please review the failed checks and fix issues before merging.' : '✅ All automated checks passed. Ready for human review.'}`;

            if (context.payload.pull_request) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }
